<!DOCTYPE html>
<html>
<head>
    <title>GPT-3.5 Turbo Chat</title>
    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>
    <h1>Welcome to GPT-3.5 Turbo Chat</h1>

    <div id="chat-box">
        {% if latest_user_message %}
            <div class="chat-message {{ latest_user_message.role }}">
                <div class="chat-bubble">
                    {{ latest_user_message.content }}
                </div>
            </div>
        {% endif %}
        
        {% if latest_assistant_message %}
            <div class="chat-message {{ latest_assistant_message.role }}">
                <div class="chat-bubble">
                    {% if is_last_image %}
                        <img src="{{ latest_assistant_message.content }}" alt="Generated by DALL-E" width="300">
                    {% else %}
                        {{ latest_assistant_message.content }}
                    {% endif %}
                </div>
            </div>
        {% endif %}
        <form action="{{ url_for('gpt3_chat') }}" method="post" id="chat-form">
            <input type="text" id="prompt" name="prompt" placeholder="Type your message..." required>
            <input type="submit" value="Send">
        </form>
    </div>
    <div class="link-container"> <!-- New container for the links -->
        <a href="{{ url_for('dashboard') }}">Back to Dashboard</a>
        <a href="{{ url_for('logout') }}">Logout</a>
    </div>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        function isValidURL(string) {
                        try {
                            new URL(string);
                            return true;
                            } catch (_) {
                                return false;
                            }}
        let lastIndex = 0;

        function fetchNewMessages() {
            $.get(`/get_new_messages/${lastIndex}`, function(data) {
                const newMessages = data.new_messages;
                lastIndex = data.new_last_index;

                newMessages.forEach((message) => {
                    const messageDiv = document.createElement("div");
                    messageDiv.classList.add("chat-message", message.role);
                
                    const bubbleDiv = document.createElement("div");
                    bubbleDiv.classList.add("chat-bubble");

                    if (message.role === 'assistant' && isValidURL(message.content)) {
                        const img = document.createElement("img");
                        img.src = message.content;
                        img.alt = "Generated by DALL-E";
                        img.width = 300;
                        bubbleDiv.appendChild(img);
                    } else {
                        bubbleDiv.innerText = message.content;
                    }
                    messageDiv.appendChild(bubbleDiv);
                    document.getElementById("chat-box").appendChild(messageDiv);
                });
            });
        }

    // Fetch new messages every 1 second
        setInterval(fetchNewMessages, 1000);
    </script>
</body>
</html>